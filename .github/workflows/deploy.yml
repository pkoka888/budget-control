name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.budgetcontrol.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install dependencies
        run: |
          cd budget-app
          if [ -f composer.json ]; then
            composer install --no-dev --optimize-autoloader
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build assets
        run: |
          npm ci
          cd budget-app
          npm run build || echo "No build script"

      - name: Run tests
        run: |
          cd budget-app
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit
          fi

      - name: Create deployment package
        run: |
          tar -czf deploy-staging.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='test-results' \
            --exclude='playwright-report' \
            budget-app/ \
            .github/ \
            package.json \
            package-lock.json

      - name: Deploy notification
        run: |
          echo "üöÄ Staging deployment prepared"
          echo "Package: deploy-staging.tar.gz"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

      # Add your actual deployment steps here
      # Examples:
      # - Upload to server via SCP
      # - Deploy to cloud provider
      # - Update Docker container
      # - Restart services

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://budgetcontrol.example.com
    needs: []

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install dependencies
        run: |
          cd budget-app
          if [ -f composer.json ]; then
            composer install --no-dev --optimize-autoloader --no-interaction
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build assets
        run: |
          npm ci
          cd budget-app
          npm run build || echo "No build script"

      - name: Run tests
        run: |
          cd budget-app
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit
          fi

      - name: Security check
        run: |
          echo "Running security checks..."
          ! grep -r "password\s*=\s*['\"][^'\"]\+['\"]" budget-app/src/ || exit 1
          ! grep -r "DEBUG.*=.*true" budget-app/ || exit 1
          echo "‚úì Security checks passed"

      - name: Create deployment package
        run: |
          tar -czf deploy-production.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='test-results' \
            --exclude='playwright-report' \
            --exclude='*.md' \
            budget-app/ \
            package.json \
            package-lock.json

      - name: Production deployment notification
        run: |
          echo "üöÄ Production deployment prepared"
          echo "Package: deploy-production.tar.gz"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "‚ö†Ô∏è  Manual approval required for production deployment"

      # Add your actual deployment steps here
      # Production deployments should include:
      # - Database backup before deployment
      # - Gradual rollout
      # - Health check verification
      # - Rollback plan ready

  post-deploy:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: always()

    steps:
      - name: Health check
        run: |
          echo "Performing post-deployment checks..."
          # Add health check URL
          # curl -f https://staging.budgetcontrol.example.com/health || exit 1

      - name: Notification
        run: |
          echo "üìä Deployment Summary"
          echo "Environment: Staging"
          echo "Status: ${{ needs.deploy-staging.result }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
